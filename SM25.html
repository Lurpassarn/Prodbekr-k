<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM25 Produktionsplan</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="sm25-app">
        <aside class="sm25-sidebar">
            <div class="sm25-logo">SM25</div>
            <nav>
                <a href="index.html" class="sidebar-link">&#8592; Tillbaka till översikt</a>
            </nav>
            <div class="sm25-shift-sidebar" style="display: flex; flex-direction: column; align-items: stretch; gap: 24px;">
                <h2 style="margin-bottom: 0;">Välj skift</h2>
                <div class="sm25-shift-list" style="display: flex; flex-direction: column; gap: 16px;">
                    <button class="sm25-shift-btn" data-shift="FM">FM-Skift</button>
                    <button class="sm25-shift-btn" data-shift="EM">EM-Skift</button>
                    <button class="sm25-shift-btn" data-shift="Natt">Natt-Skift</button>
                </div>
            </div>
        </aside>
        <main class="sm25-main">
            <header class="sm25-header">
                <h1>SM25 Produktionsplan</h1>
                <p class="sm25-sub">Planering och uträkning för dagens produktion. Välj skift i sidomenyn.</p>
            </header>
            <div id="shiftBarContainer" style="margin-bottom: 24px;"></div>
            <div id="ordersContainer"></div>
        </main>
    </div>
    <div class="guidance" style="margin-left: 260px;">
        <p><strong>Övrigt att tänka på:</strong> Tider baseras på "Arklängd" och "RawRollWidth". Använd stoppfunktionen vid pauser. Kontrollera varningar för saknad data.</p>
    </div>
    <script src="production.js"></script>
    <script>
        let isPaused = false;
        let pauseStartTime = 0;
        let totalPauseTime = 0;
        let customOrders = null; // Null = använd original, array = använd denna ordning
        let originalOrders = null; // Spara originalordning från JSON

        async function loadOrders(forceReload = false) {
            if (!originalOrders || forceReload) {
                const response = await fetch('SM25.json');
                originalOrders = await response.json();
            }
            // Om customOrders är null, använd originalordning
            let orders = customOrders ? customOrders.map(idx => originalOrders[idx]) : originalOrders.slice();
            console.log('[DEBUG] loadOrders customOrders:', customOrders, 'orders:', orders.map(o => o['Kundorder']));
            const ordersWithTimes = calculateAllProductionTimes(orders);
            const ordersContainer = document.getElementById('ordersContainer');
            ordersContainer.innerHTML = '';
            const shifts = { FM: [], EM: [], Natt: [] };
            const shiftNames = { FM: 'FM-Skift', EM: 'EM-Skift', Natt: 'Natt-Skift' };
            const shiftLimits = {
                FM: 14 * 60, // 06:00-14:00
                EM: 22.5 * 60, // 14:00-22:30
                Natt: 30 * 60 // 22:30-06:00 (nästa dag)
            };
            let currentTime = 6 * 60; // Start vid 06:00 i minuter
            let usedMinutes = 0;
            let shiftCurrent = { FM: 6 * 60, EM: 14 * 60, Natt: 22.5 * 60 };
            // Fyll varje skift för sig tills dess sluttid
            for (let shiftKey of ['FM', 'EM', 'Natt']) {
                let shiftStart = shiftCurrent[shiftKey];
                let shiftEnd = shiftLimits[shiftKey];
                for (let i = 0; i < ordersWithTimes.length; i++) {
                    const order = ordersWithTimes[i];
                    if (order._scheduled) continue; // Hoppa redan schemalagda ordrar
                    const time = order.productionTimeNormal || order.productionTimeSaxning || 0;
                    const adjustedTime = isPaused ? time + (totalPauseTime / 60) : time;
                    // Hantera midnatt: Om start/slut går över 24:00 (1440 min), börja om på 0
                    let realStart = shiftStart;
                    let realEnd = shiftStart + adjustedTime;
                    if (realStart >= 1440) realStart -= 1440;
                    if (realEnd >= 1440) realEnd -= 1440;
                    // Exkludera ordrar som INTE startar efter 22:30 eller slutar före 06:00 (efter midnatt)
                    if (shiftKey === 'Natt' && !(realStart >= 1350 || realEnd <= 360)) {
                        console.log('[DEBUG] SKIP', order['Kundorder'], 'not valid for Natt', {realStart, realEnd});
                        continue;
                    }
                    // Om ordern inte får plats i skiftet, hoppa över
                    if (shiftStart + adjustedTime > shiftEnd) {
                        console.log('[DEBUG] SKIP', order['Kundorder'], 'does not fit in', shiftKey, {shiftStart, adjustedTime, shiftEnd});
                        continue;
                    }
                    order.startTime = realStart;
                    order.endTime = realEnd;
                    order.shift = shiftKey;
                    order.adjustedTime = adjustedTime;
                    order.productionTime = time;
                    order.isSaxning = (parseFloat(order['RawRollWidth'] || '0') <= 1035 && estimateRollCount(order) >= 2);
                    order.isProfitable = order.isSaxning ? (order.productionTimeSaxning < order.productionTimeNormal) : false;
                    shifts[shiftKey].push(order);
                    order._scheduled = true;
                    console.log('[DEBUG] ASSIGN', order['Kundorder'], 'to', shiftKey, {shiftStart, shiftEnd, adjustedTime});
                    shiftStart = order.endTime >= 1440 ? order.endTime - 1440 : order.endTime;
                    usedMinutes += adjustedTime;
                    if (usedMinutes >= 24 * 60) break;
                }
                if (usedMinutes >= 24 * 60) break;
            }

            // NYTT: Tillåt att order delas över flera skift
            for (let i = 0; i < ordersWithTimes.length; i++) {
                let order = ordersWithTimes[i];
                let remainingTime = order.productionTimeNormal || order.productionTimeSaxning || 0;
                let totalOrderTime = remainingTime;
                let orderProduced = 0;
                let totalOrderProduced = parseFloat(order['Planerad Vikt'] || 0);
                let producedSoFar = 0;
                let orderSplits = [];
                for (let shiftKey of ['FM', 'EM', 'Natt']) {
                    let shiftStart = shiftCurrent[shiftKey];
                    let shiftEnd = shiftLimits[shiftKey];
                    let availableTime = shiftEnd - shiftStart;
                    if (availableTime <= 0 || remainingTime <= 0) continue;
                    // Om ordern är större än skiftet, dela upp
                    let timeForThisShift = Math.min(availableTime, remainingTime);
                    let percentOfOrder = timeForThisShift / totalOrderTime;
                    let producedThisShift = totalOrderProduced * percentOfOrder;
                    // Hantera midnatt
                    let realStart = shiftStart;
                    let realEnd = shiftStart + timeForThisShift;
                    if (realStart >= 1440) realStart -= 1440;
                    if (realEnd >= 1440) realEnd -= 1440;
                    // Exkludera ordrar som INTE startar efter 22:30 eller slutar före 06:00 (efter midnatt)
                    if (shiftKey === 'Natt' && !(realStart >= 1350 || realEnd <= 360)) {
                        continue;
                    }
                    // Skapa en split för denna del av ordern
                    let splitOrder = Object.assign({}, order);
                    splitOrder.startTime = realStart;
                    splitOrder.endTime = realEnd;
                    splitOrder.shift = shiftKey;
                    splitOrder.adjustedTime = timeForThisShift;
                    splitOrder.productionTime = timeForThisShift;
                    splitOrder.isSaxning = (parseFloat(order['RawRollWidth'] || '0') <= 1035 && estimateRollCount(order) >= 2);
                    splitOrder.isProfitable = splitOrder.isSaxning ? (order.productionTimeSaxning < order.productionTimeNormal) : false;
                    splitOrder._scheduled = true;
                    splitOrder._split = true;
                    splitOrder._splitProduced = producedThisShift;
                    splitOrder._splitTotal = totalOrderProduced;
                    splitOrder._splitIndex = orderSplits.length + 1;
                    splitOrder._splitCount = null; // Fylls i efteråt
                    shifts[shiftKey].push(splitOrder);
                    orderSplits.push(splitOrder);
                    shiftCurrent[shiftKey] = realEnd >= 1440 ? realEnd - 1440 : realEnd;
                    usedMinutes += timeForThisShift;
                    remainingTime -= timeForThisShift;
                    producedSoFar += producedThisShift;
                    if (usedMinutes >= 24 * 60) break;
                    if (remainingTime <= 0) break;
                }
                // Sätt antal splits på alla splits
                orderSplits.forEach(s => s._splitCount = orderSplits.length);
            }

            // NY LOGIK: Tillåt att order startar mitt i ett skift och delas korrekt över skift
            currentTime = 6 * 60; // Start vid 06:00 i minuter
            usedMinutes = 0;
            shiftCurrent = { FM: 6 * 60, EM: 14 * 60, Natt: 22.5 * 60 };
            for (let i = 0; i < ordersWithTimes.length; i++) {
                let order = ordersWithTimes[i];
                let remainingTime = order.productionTimeNormal || order.productionTimeSaxning || 0;
                let totalOrderTime = remainingTime;
                let totalOrderProduced = parseFloat(order['Planerad Vikt'] || 0);
                let producedSoFar = 0;
                let orderSplits = [];
                // Hitta startskift baserat på order.startTime (om finns), annars använd currentTime
                let orderStartTime = order.startTime != null ? order.startTime : currentTime;
                let shiftKeys = ['FM', 'EM', 'Natt'];
                // Hitta rätt skift att börja i
                let startShiftIdx = 0;
                for (let s = 0; s < shiftKeys.length; s++) {
                    if (orderStartTime >= shiftCurrent[shiftKeys[s]] && orderStartTime < shiftLimits[shiftKeys[s]]) {
                        startShiftIdx = s;
                        break;
                    }
                }
                let localStartTime = orderStartTime;
                for (let s = startShiftIdx; s < shiftKeys.length; s++) {
                    let shiftKey = shiftKeys[s];
                    let shiftStart = Math.max(shiftCurrent[shiftKey], localStartTime);
                    let shiftEnd = shiftLimits[shiftKey];
                    let availableTime = shiftEnd - shiftStart;
                    if (availableTime <= 0 || remainingTime <= 0) continue;
                    let timeForThisShift = Math.min(availableTime, remainingTime);
                    let percentOfOrder = timeForThisShift / totalOrderTime;
                    let producedThisShift = totalOrderProduced * percentOfOrder;
                    // Hantera midnatt
                    let realStart = shiftStart;
                    let realEnd = shiftStart + timeForThisShift;
                    if (realStart >= 1440) realStart -= 1440;
                    if (realEnd >= 1440) realEnd -= 1440;
                    // Exkludera ordrar som INTE startar efter 22:30 eller slutar före 06:00 (efter midnatt)
                    if (shiftKey === 'Natt' && !(realStart >= 1350 || realEnd <= 360)) {
                        continue;
                    }
                    // Skapa en split för denna del av ordern
                    let splitOrder = Object.assign({}, order);
                    splitOrder.startTime = realStart;
                    splitOrder.endTime = realEnd;
                    splitOrder.shift = shiftKey;
                    splitOrder.adjustedTime = timeForThisShift;
                    splitOrder.productionTime = timeForThisShift;
                    splitOrder.isSaxning = (parseFloat(order['RawRollWidth'] || '0') <= 1035 && estimateRollCount(order) >= 2);
                    splitOrder.isProfitable = splitOrder.isSaxning ? (order.productionTimeSaxning < order.productionTimeNormal) : false;
                    splitOrder._scheduled = true;
                    splitOrder._split = true;
                    splitOrder._splitProduced = producedThisShift;
                    splitOrder._splitTotal = totalOrderProduced;
                    splitOrder._splitIndex = orderSplits.length + 1;
                    splitOrder._splitCount = null; // Fylls i efteråt
                    shifts[shiftKey].push(splitOrder);
                    orderSplits.push(splitOrder);
                    shiftCurrent[shiftKey] = realEnd >= 1440 ? realEnd - 1440 : realEnd;
                    usedMinutes += timeForThisShift;
                    remainingTime -= timeForThisShift;
                    producedSoFar += producedThisShift;
                    localStartTime = shiftLimits[shiftKey]; // Nästa skift börjar där förra slutade
                    if (usedMinutes >= 24 * 60) break;
                    if (remainingTime <= 0) break;
                }
                // Sätt antal splits på alla splits
                orderSplits.forEach(s => s._splitCount = orderSplits.length);
                // Efter första ordern, currentTime ska alltid vara där förra slutade
                if (orderSplits.length > 0) {
                    currentTime = orderSplits[orderSplits.length-1].endTime;
                }
            }

            // Skiftsektioner (en i taget visas)
            Object.keys(shifts).forEach(shift => {
                const shiftWrapper = document.createElement('div');
                shiftWrapper.className = 'shift-wrapper';
                shiftWrapper.id = 'section-' + shift;
                shiftWrapper.style.display = 'none';

                // Summering
                const shiftSummary = document.createElement('div');
                shiftSummary.className = 'shift-summary';
                const totalKg = shifts[shift].reduce((acc, order) => acc + parseFloat(order['Planerad Vikt'] || 0), 0);
                const totalOrders = shifts[shift].length;
                const totalTime = shifts[shift].reduce((acc, order) => acc + order.adjustedTime, 0);
                const kgPerHour = totalTime > 0 ? (totalKg / (totalTime / 60)) : 50;
                const isHighProduction = kgPerHour > 50;
                const analysis = [];
                if (isHighProduction) {
                    analysis.push('+ Hög produktionstakt, effektiva ordrar. 📈');
                    if (totalOrders > 5) analysis.push('+ Många ordrar ökar genomströmning.');
                } else {
                    analysis.push('- Låg produktionstakt, kontrollera orderstorlek. 📉');
                    if (totalOrders < 3) analysis.push('- Få ordrar kan minska effektivitet.');
                }
                shiftSummary.innerHTML = `
                    <h3>Summering för ${shiftNames[shift]}:</h3>
                    <p>Planerad produktion: ${totalKg.toFixed(2)} kg</p>
                    <p>Körda ordrar: ${totalOrders}</p>
                    <p>Summa KG/TIM: ${kgPerHour.toFixed(2)}</p>
                    <div class="analysis">${analysis.map(a => `<p>${a}</p>`).join('')}</div>
                `;
                shiftWrapper.appendChild(shiftSummary);

                // Ordrar
                // Ordrar i grid-layout, 3 per rad
                const ordersGrid = document.createElement('div');
                ordersGrid.className = 'orders-grid sm25-orders-grid';
                shifts[shift].forEach((order, idx) => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'order-box sm25-order-card';
                    // NYTT: Visa split-info om ordern är splittrad
                    let splitInfo = '';
                    if (order._splitCount && order._splitCount > 1) {
                        splitInfo = `<div style='font-size:0.98em;color:#64748b;margin-bottom:2px;'>Del ${order._splitIndex} av ${order._splitCount} (skift-split)</div>`;
                    }
                    orderDiv.innerHTML = `
                        <div class="order-card-header">
                            <span class="order-icon">📦</span>
                            <h3 style="margin:0; color:#2563eb; font-weight:700;">${order['Kundorder'] || 'Okänd'}</h3>
                        </div>
                        ${splitInfo}
                        <div class="order-card-row">
                            <span class="order-label">Start:</span> <span>${formatTime(order.startTime)}</span>
                        </div>
                        <div class="order-card-row">
                            <span class="order-label">Färdig:</span> <span>${formatTime(order.endTime)}</span>
                        </div>
                        <div class="order-card-row">
                            <span class="order-label">Tid:</span> <span>${order.adjustedTime.toFixed(2)} min</span>
                        </div>
                        <div class="order-card-row">
                            <span class="order-label">Vikt i detta skift:</span> <span>${order._splitProduced ? order._splitProduced.toFixed(2) : (order['Planerad Vikt'] || 0).toFixed(2)} kg</span>
                        </div>
                        <div class="order-card-row">
                            <span class="order-label">Total ordervikt:</span> <span>${order._splitTotal ? order._splitTotal.toFixed(2) : (order['Planerad Vikt'] || 0).toFixed(2)} kg</span>
                        </div>
                        <div class="order-card-actions">
                            <button class="show-calc-btn">Visa Uträkning</button>
                        </div>
                        <div class="calc-result" style="display:none;"></div>
                    `;
                    // Show calculation
                    orderDiv.querySelector('.show-calc-btn').addEventListener('click', function() {
                        showOrderCalculation(this, order);
                    });
                    ordersGrid.appendChild(orderDiv);
                });
                shiftWrapper.appendChild(ordersGrid);
                ordersContainer.appendChild(shiftWrapper);
            });

            // Efter att skiftsektioner skapats:
            renderShiftsSidebar(shifts);
            renderShiftBar(shifts); // <-- Lägg till stapelvisning
        }

        // Visa uträkning direkt under ordern
        function showOrderCalculation(btn, order) {
            const resultDiv = btn.closest('.order-card-actions').nextElementSibling;
            if (resultDiv.style.display === 'block') {
                resultDiv.style.display = 'none';
                return;
            }
            resultDiv.style.display = 'block';

            // Visa endast de fält som används för tidsberäkning, i en horisontell container
            const usedFields = [
                { key: 'Kundorder', label: 'Ordernummer' },
                { key: 'Arklängd', label: 'Arklängd' },
                { key: 'RawRollWidth', label: 'RawRollWidth' },
                { key: 'Planerad Vikt', label: 'Planerad Vikt' },
                { key: 'Gramvikt', label: 'Gramvikt' },
                { key: 'Antal banor', label: 'Antal banor' },
                { key: 'Tompallar', label: 'Tompallar' },
                { key: 'rullar', label: 'Rullar' }
            ];
            let html = `<div class="order-calc-horizontal-container">`;
            usedFields.forEach(f => {
                html += `<div class="order-calc-field"><span class="order-calc-label">${f.label}:</span><span class="order-calc-value">${order[f.key] ?? '<span style=\'color:#b91c1c\'>saknas</span>'}</span></div>`;
            });
            html += `</div>`;

            // Förklaringstext om Tompallar och rullar
            html += `<div style='margin: 10px 0 0 0; font-size: 1em; color: #234; background: #e0e7ef; border-radius: 7px; padding: 10px 16px;'>
                <b>Info:</b> <br>
                <span><b>Tompallar</b> används för att beräkna antalet tompallar som behövs för ordern. <b>Rullar</b> anger hur många rullar som ingår i ordern och påverkar stopp- och hanteringstider.</span>
            </div>`;

            // Visa beräknad maskinhastighet
            let sheetLength = parseFloat(order['Arklängd']) || 0;
            let speed = getMachineSpeed('SM25', sheetLength);
            let speedHtml = `<div class="order-calc-speed"><b>Beräknad maskinhastighet:</b> <span>${speed.toFixed(2)} m/min</span></div>`;

            resultDiv.innerHTML = html + speedHtml;
        }

        function addStop() {
            if (!isPaused) {
                isPaused = true;
                pauseStartTime = new Date().getTime();
                document.getElementById('stopInfo').textContent = 'Stopp pausat, klicka igen för att återuppta.';
            } else {
                const pauseEndTime = new Date().getTime();
                const pauseDuration = (pauseEndTime - pauseStartTime) / 1000 / 60; // Minuter
                totalPauseTime += pauseDuration;
                isPaused = false;
                document.getElementById('stopInfo').textContent = `Stopp återupptaget, paus: ${pauseDuration.toFixed(2)} min. Omräknat.`;
                loadOrders(); // Omräkna med ny tid
            }
        }

        // Hjälpfunktion för att formatera tid
        function formatTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = Math.round(minutes % 60);
            return `kl ${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        loadOrders();

        // Efter loadOrders, lägg till kod för att förbättra UI:t direkt i scriptet (för att undvika 90-talskänsla)
        document.addEventListener('DOMContentLoaded', function() {
            // Modernare font och bakgrund
            document.body.style.background = 'linear-gradient(120deg, #f8fafc 0%, #e0e7ef 100%)';
            document.body.style.fontFamily = 'Roboto, Arial, sans-serif';
            document.body.style.fontSize = '18px';
            document.body.style.color = '#222';
            // Container
            const container = document.querySelector('.container');
            if (container) {
                container.style.maxWidth = '900px';
                container.style.margin = '40px auto';
                container.style.background = '#fff';
                container.style.borderRadius = '18px';
                container.style.boxShadow = '0 4px 24px 0 rgba(60,80,120,0.10)';
                container.style.padding = '32px 32px 24px 32px';
            }
            // Skiftbar
            const style = document.createElement('style');
            style.innerHTML = `
                .shift-bar { display: flex; justify-content: center; gap: 24px; margin: 32px 0 16px 0; }
                .shift-toggle { position: relative; font-weight: 600; letter-spacing: 0.5px; box-shadow: 0 2px 8px #e0e7ef, 0 0 0 2px #3b82f6 inset; }
                .shift-toggle .shift-arrow { font-size: 1.2em; margin-right: 8px; transition: transform 0.2s; }
                .shift-toggle.active-shift .shift-arrow { transform: rotate(90deg); }
                .shift-toggle:after { content: 'Klicka för att visa'; display: block; font-size: 0.85em; color: #2563eb; margin-top: 2px; font-weight: 400; letter-spacing: 0; }
                .shift-wrapper { background: #f4f7fb; border-radius: 0 0 12px 12px; box-shadow: 0 2px 12px #e0e7ef; margin-bottom: 32px; padding: 24px 24px 12px 24px; }
                .shift-summary { background: #e0e7ef; border-radius: 8px; margin: 0 0 18px 0; padding: 16px 20px; font-size: 1.08em; }
                .order-box { background: #fff; border-radius: 8px; box-shadow: 0 1px 6px #e0e7ef; margin: 18px 0; padding: 18px 22px; display: flex; flex-direction: column; gap: 6px; }
                .order-box h3 { margin: 0 0 4px 0; font-size: 1.15em; color: #2563eb; }
                .order-box button { align-self: flex-start; background: #3b82f6; color: #fff; border: none; border-radius: 6px; padding: 7px 18px; font-size: 1em; margin-top: 6px; cursor: pointer; transition: background 0.2s; }
                .order-box button:hover { background: #2563eb; }
                .calc-result { background: #f1f5fa; border-left: 4px solid #3b82f6; border-radius: 0 6px 6px 0; margin: 10px 0 0 0; padding: 10px 18px; font-size: 0.98em; color: #234; }
                .orders-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
                    gap: 18px 18px;
                    margin-top: 18px;
                }
                /* Lägg till CSS för horisontell container och tydligare fält */
                .order-calc-horizontal-container {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 24px;
                    background: #f8fafc;
                    border-radius: 10px;
                    padding: 18px 20px 12px 20px;
                    margin-bottom: 10px;
                    box-shadow: 0 2px 8px #e0e7ef;
                }
                .order-calc-field {
                    display: flex;
                    flex-direction: column;
                    min-width: 120px;
                    padding: 6px 10px;
                    background: #e0e7ef;
                    border-radius: 7px;
                    font-size: 1.08em;
                    align-items: flex-start;
                }
                .order-calc-label {
                    font-weight: 600;
                    color: #2563eb;
                    margin-bottom: 2px;
                }
                .order-calc-value {
                    font-family: 'Roboto Mono', monospace;
                    color: #222;
                    font-size: 1.08em;
                }
                .order-calc-speed {
                    margin: 10px 0 0 0;
                    font-size: 1.12em;
                    color: #234;
                    background: #e0e7ef;
                    border-radius: 7px;
                    padding: 10px 16px;
                    display: inline-block;
                    font-weight: 500;
                }
                @media (max-width: 700px) {
                    .container { padding: 8px !important; }
                    .shift-bar { flex-direction: column; gap: 10px; }
                    .shift-wrapper { padding: 10px 4px; }
                    .order-box { padding: 10px 6px; }
                    .order-calc-horizontal-container {
                        flex-direction: column;
                        gap: 10px;
                        padding: 10px 6px 8px 6px;
                    }
                    .order-calc-field {
                        min-width: 0;
                        width: 100%;
                        padding: 6px 6px;
                    }
                    .order-calc-speed {
                        width: 100%;
                        padding: 8px 8px;
                    }
                }
            `;
            document.head.appendChild(style);
        });

        // CSS for modal and button
        const customOrderStyle = document.createElement('style');
        customOrderStyle.innerHTML = `
        .custom-order-btn {
            background: #2563eb;
            color: #fff;
            font-size: 1.1em;
            border: none;
            border-radius: 7px;
            padding: 10px 24px;
            margin: 18px 0 18px 0;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 8px #e0e7ef;
            transition: background 0.2s;
        }
        .custom-order-btn:hover { background: #1746a0; }
        .custom-order-modal {
            position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(30,40,60,0.18); z-index: 1000; display: flex; align-items: center; justify-content: center;
        }
        .custom-order-modal-content {
            background: #fff; border-radius: 14px; box-shadow: 0 4px 32px #b6c6e6; padding: 32px 32px 24px 32px; min-width: 320px; max-width: 95vw;
        }
        .custom-order-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 16px 24px; margin-bottom: 18px; }
        .custom-order-fields label { display: flex; flex-direction: column; font-weight: 500; color: #234; }
        .custom-order-fields input { margin-top: 4px; padding: 7px 10px; border-radius: 6px; border: 1px solid #b6c6e6; font-size: 1em; }
        .custom-order-modal-actions { display: flex; gap: 18px; justify-content: flex-end; }
        .custom-order-save-btn { background: #2563eb; color: #fff; border: none; border-radius: 6px; padding: 8px 18px; font-size: 1em; cursor: pointer; font-weight: 600; }
        .custom-order-cancel-btn { background: #e0e7ef; color: #234; border: none; border-radius: 6px; padding: 8px 18px; font-size: 1em; cursor: pointer; font-weight: 600; }
        @media (max-width: 700px) {
            .custom-order-modal-content { padding: 12px 6px 12px 6px; min-width: 0; }
            .custom-order-fields { grid-template-columns: 1fr; gap: 10px; }
        }
        `;
        document.head.appendChild(customOrderStyle);

        // JS for custom order modal and logic
        let replaceOrderIndex = null;

        // Ta bort all kod för openChooseJsonOrderModal, closeChooseJsonOrderModal och relaterad patchReplaceOrderBtns
        // --- Lägg till/aktivera endast drag-and-drop-modal och knapp ---
        if (!document.getElementById('reorderOrdersBtn')) {
          const header = document.querySelector('.sm25-header');
          const reorderBtn = document.createElement('button');
          reorderBtn.id = 'reorderOrdersBtn';
          reorderBtn.className = 'custom-order-btn';
          reorderBtn.textContent = 'Ändra ordning på ordrar';
          reorderBtn.style.marginLeft = '18px';
          reorderBtn.onclick = openReorderOrdersModal;
          header.appendChild(reorderBtn);
        } else {
          document.getElementById('reorderOrdersBtn').onclick = openReorderOrdersModal;
        }
        // --- Drag-and-drop-modal för att ändra ordning på ordrar ---
        function openReorderOrdersModal() {
            let modal = document.getElementById('reorderOrdersModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'reorderOrdersModal';
                modal.className = 'custom-order-modal';
                modal.innerHTML = `<div class="custom-order-modal-content">
                    <h2>Ändra ordning på ordrar</h2>
                    <ul id="reorderList" style="list-style:none;padding:0;margin-bottom:18px;display:flex;flex-direction:column;gap:8px;max-width:100%;width:100%;"></ul>
                    <div class="custom-order-modal-actions">
                        <button type="button" id="applyReorderBtn" class="custom-order-save-btn">Uppdatera</button>
                        <button type="button" id="resetOrderListBtn" class="custom-order-cancel-btn">Återställ ordning</button>
                        <button type="button" id="closeReorderModalBtn" class="custom-order-cancel-btn">Stäng</button>
                    </div>
                </div>`;
                document.body.appendChild(modal);
            }
            modal.style.display = 'flex';
            const ul = modal.querySelector('#reorderList');
            ul.style.display = 'flex';
            ul.style.flexDirection = 'column';
            ul.style.gap = '8px';
            ul.style.maxWidth = '100%';
            ul.style.width = '100%';
            ul.style.overflowY = 'auto';
            ul.style.background = '#f8fafc';
            ul.style.borderRadius = '8px';
            ul.style.padding = '8px 0';
            let orderIdxs = customOrders ? customOrders.slice() : originalOrders.map((_,i)=>i);
            function renderList() {
                console.log('[DEBUG] renderList orderIdxs:', orderIdxs);
                ul.innerHTML = '';
                let prevShift = null;
                orderIdxs.forEach((idx, i) => {
                    const order = originalOrders[idx];
                    // Skiftbyte: visa streck före första ordern i nytt skift
                    if (order.shift && order.shift !== prevShift) {
                        const divider = document.createElement('div');
                        divider.style.borderTop = '2px dashed #2563eb';
                        divider.style.margin = '6px 0 6px 0';
                        divider.style.width = '100%';
                        divider.style.opacity = '0.7';
                        divider.title = 'Skiftbyte (' + order.shift + ')';
                        ul.appendChild(divider);
                        prevShift = order.shift;
                    }
                    const li = document.createElement('li');
                    li.style.marginBottom = '0';
                    li.style.display = 'flex';
                    li.style.alignItems = 'center';
                    li.style.flex = '1 1 auto';
                    li.style.width = '100%';
                    li.style.cursor = 'grab';
                    li.style.fontSize = '1em';
                    li.style.padding = '4px 8px';
                    li.setAttribute('draggable', 'true');
                    li.setAttribute('data-idx', i);
                    li.innerHTML = `<span style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${order['Kundorder'] || 'Okänd'} - ${order['Planerad Vikt'] || '?'} kg</span>` +
                        `<button style="margin-right:4px;background:#22c55e;border:none;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0;" class="move-up-btn" title="Flytta upp"><svg width="14" height="14" viewBox="0 0 14 14"><path d="M7 3l4 5H3z" fill="#fff"/></svg></button>` +
                        `<button style="background:#ef4444;border:none;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0;" class="move-down-btn" title="Flytta ner"><svg width="14" height="14" viewBox="0 0 14 14"><path d="M7 11l-4-5h8z" fill="#fff"/></svg></button>`;
                    // Drag and drop events
                    li.ondragstart = function(e) {
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', i);
                        li.style.opacity = '0.5';
                    };
                    li.ondragend = function() {
                        li.style.opacity = '';
                    };
                    li.ondragover = function(e) {
                        e.preventDefault();
                        li.style.background = '#e0e7ef';
                    };
                    li.ondragleave = function() {
                        li.style.background = '';
                    };
                    li.ondrop = function(e) {
                        e.preventDefault();
                        li.style.background = '';
                        const from = parseInt(e.dataTransfer.getData('text/plain'));
                        const to = i;
                        if (from !== to) {
                            const moved = orderIdxs.splice(from, 1)[0];
                            orderIdxs.splice(to, 0, moved);
                            renderList();
                        }
                    };
                    // Move up/down buttons
                    li.querySelector('.move-up-btn').onclick = function(e) {
                        e.stopPropagation();
                        if (i > 0) {
                            [orderIdxs[i-1], orderIdxs[i]] = [orderIdxs[i], orderIdxs[i-1]];
                            renderList();
                        }
                    };
                    li.querySelector('.move-down-btn').onclick = function(e) {
                        e.stopPropagation();
                        if (i < orderIdxs.length-1) {
                            [orderIdxs[i+1], orderIdxs[i]] = [orderIdxs[i], orderIdxs[i+1]];
                            renderList();
                        }
                    };
                    ul.appendChild(li);
                });
            }
            renderList();
            // Spara ändrad ordning
            modal.querySelector('#applyReorderBtn').onclick = function() {
                // Debug: log before saving
                console.log('[DEBUG] Uppdatera clicked. orderIdxs:', orderIdxs);
                customOrders = orderIdxs.slice();
                console.log('[DEBUG] customOrders after update:', customOrders);
                // --- NYTT: Behåll öppet skift ---
                const prevShift = expandedShift;
                closeReorderOrdersModal();
                loadOrders();
                if (prevShift) {
                    setTimeout(() => {
                        const btn = document.querySelector(`.sm25-shift-btn[data-shift="${prevShift}"]`);
                        if (btn) btn.click();
                    }, 0);
                }
            };
            // Återställ-knapp
            modal.querySelector('#resetOrderListBtn').onclick = function() {
                customOrders = null;
                closeReorderOrdersModal();
                loadOrders();
            };
            // Stäng-modal
            modal.querySelector('#closeReorderModalBtn').onclick = function() {
                closeReorderOrdersModal();
            };
        }
        function closeReorderOrdersModal() {
            const modal = document.getElementById('reorderOrdersModal');
            if (modal) modal.style.display = 'none';
        }

        // Byt ut shiftBar och shift-knappar mot sidebar-knappar
        // Hantera skiftval via sidebar
        let expandedShift = null;
        function renderShiftsSidebar(shifts) {
            document.querySelectorAll('.sm25-shift-btn').forEach(btn => {
                btn.onclick = function() {
                    const shift = btn.getAttribute('data-shift');
                    Object.keys(shifts).forEach(s => {
                        const sec = document.getElementById('section-' + s);
                        if (sec) sec.style.display = 'none';
                        const b = document.querySelector(`.sm25-shift-btn[data-shift="${s}"]`);
                        if (b) b.classList.remove('active-shift');
                    });
                    const section = document.getElementById('section-' + shift);
                    if (section) {
                        section.style.display = 'block';
                        btn.classList.add('active-shift');
                        expandedShift = shift;
                    } else {
                        btn.classList.remove('active-shift');
                        expandedShift = null;
                    }
                };
            });

            // Klickhantering för stapelsegmenten (shiftBar)
            document.querySelectorAll('.shift-segment').forEach(seg => {
                seg.addEventListener('click', function() {
                    const shift = this.getAttribute('data-shift');
                    const btn = document.querySelector(`.sm25-shift-btn[data-shift="${shift}"]`);
                    if (btn) { btn.click(); }
                });
            });
        }

        // Skapa stapelvisning för skift
        function renderShiftBar(shifts) {
            const container = document.getElementById('shiftBarContainer');
            container.innerHTML = '';
            const totalKg = Object.keys(shifts).reduce((acc, key) => acc + shifts[key].reduce((a, o) => a + parseFloat(o['Planerad Vikt'] || 0), 0), 0);
            if (totalKg === 0) return;
            const shiftColors = { FM: '#2563eb', EM: '#60a5fa', Natt: '#64748b' };
            const shiftNames = { FM: 'FM-Skift', EM: 'EM-Skift', Natt: 'Natt-Skift' };
            // Skapa wrapper för horisontell stapel
            const barWrapper = document.createElement('div');
            barWrapper.className = 'shift-bar-horizontal';
            Object.keys(shifts).forEach(shift => {
                const shiftData = shifts[shift];
                const shiftTotalKg = shiftData.reduce((a, o) => a + parseFloat(o['Planerad Vikt'] || 0), 0);
                const percent = totalKg > 0 ? (shiftTotalKg / totalKg) * 100 : 0;
                const seg = document.createElement('div');
                seg.className = 'shift-bar-segment-horizontal';
                seg.setAttribute('data-shift', shift);
                seg.style.width = percent + '%';
                seg.style.backgroundColor = shiftColors[shift];
                seg.title = `${shiftNames[shift]}: ${shiftTotalKg.toFixed(1)} kg (${percent.toFixed(1)}%)`;
                seg.innerHTML = `<span class="shift-bar-label-horizontal">${shiftNames[shift]}<br><b>${shiftTotalKg.toFixed(1)} kg</b><br><span class='shift-bar-percent'>${percent.toFixed(1)}%</span></span>`;
                seg.onclick = function() {
                    const btn = document.querySelector(`.sm25-shift-btn[data-shift="${shift}"]`);
                    if (btn) btn.click();
                };
                barWrapper.appendChild(seg);
            });
            container.appendChild(barWrapper);
            // Legenda
            const legend = document.createElement('div');
            legend.className = 'shift-bar-legend-horizontal';
            legend.innerHTML = Object.keys(shifts).map(shift => `
                <span class="shift-bar-legend-item">
                    <span class="shift-bar-legend-color" style="background:${shiftColors[shift]}"></span>
                    ${shiftNames[shift]}
                </span>
            `).join('');
            container.appendChild(legend);
        }
    </script>
</body>
</html>
