<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produktionsöversikt</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="main-hub">
        <header>
            <h1>Produktionsöversikt - 24-timmars cykel</h1>
            <p>Välkommen till översikten för produktionsplaneringen över 24 timmar för arkmaskinerna SM25, SM27 och SM28. Här ser du en summering av varje maskins prestanda per skift. Klicka på en maskin för detaljerad planering och uträkningar.</p>
        </header>
        <div class="summary-container">
            <h2>Summering av arkmaskiner</h2>
            <div class="summary-box" id="machineSummaries"></div>
        </div>
        <div class="nav-buttons">
            <a href="SM25.html" class="nav-button">Gå till SM25</a>
            <a href="SM27.html" class="nav-button">Gå till SM27</a>
            <a href="SM28.html" class="nav-button">Gå till SM28</a>
        </div>
        <div class="guidance">
            <p><strong>Övrigt att tänka på:</strong> Tider baseras på "Arklängd" och "RawRollWidth". Utforska maskinsidor för detaljer.</p>
        </div>
        <div class="manual-calc">
            <h2>Manuell orderberäkning</h2>
            <label for="machineSelect">Maskin</label>
            <select id="machineSelect">
                <option value="SM25">SM25</option>
                <option value="SM27">SM27</option>
                <option value="SM28">SM28</option>
            </select>
            <label for="plannedWeight">Planerad Vikt (kg)</label>
            <input type="number" id="plannedWeight" step="0.01">
            <label for="gramvikt">Gramvikt (g/m²)</label>
            <input type="number" id="gramvikt" step="0.1">
            <label for="rawRollWidth">RawRollWidth (mm)</label>
            <input type="text" id="rawRollWidth">
            <label for="arkbredd">Arkbredd (mm)</label>
            <input type="number" id="arkbredd" step="0.1">
            <label for="arklangd">Arklängd (mm)</label>
            <input type="number" id="arklangd" step="0.1">
            <label for="banor">Antal banor</label>
            <input type="number" id="banor" step="1" value="1">
            <label for="resvikt">Reserverad Vikt (kg)</label>
            <input type="number" id="resvikt" step="0.01">
            <label for="rullar">Rullar</label>
            <input type="text" id="rullar" placeholder="t.ex. 3(1)">
            <button id="calcBtn">Beräkna</button>
            <div id="calcResult" class="result"></div>
        </div>
    </div>
    <script src="production.js"></script>
    <script>
        async function loadSummary() {
            const machines = ['SM25', 'SM27', 'SM28'];
            const summaries = {};

            for (const machine of machines) {
                const response = await fetch(`${machine}.json`);
                const orders = await response.json();
                const ordersWithTimes = calculateAllProductionTimes(orders);
                // Dynamisk summering per skift, exakt som på maskinsidorna
                const shifts = { FM: [], EM: [], Natt: [] };
                const shiftLimits = {
                    FM: 14 * 60, // 06:00-14:00
                    EM: 22.5 * 60, // 14:00-22:30
                    Natt: 30 * 60 // 22:30-06:00 (nästa dag)
                };
                let usedMinutes = 0;
                let shiftCurrent = { FM: 6 * 60, EM: 14 * 60, Natt: 22.5 * 60 };
                for (let shiftKey of ['FM', 'EM', 'Natt']) {
                    let shiftStart = shiftCurrent[shiftKey];
                    let shiftEnd = shiftLimits[shiftKey];
                    for (let i = 0; i < ordersWithTimes.length; i++) {
                        const order = ordersWithTimes[i];
                        if (order._scheduled) continue;
                        const time = order.productionTimeNormal || order.productionTimeSaxning || 0;
                        // Hantera midnatt: Om start/slut går över 24:00 (1440 min), börja om på 0
                        let realStart = shiftStart;
                        let realEnd = shiftStart + time;
                        if (realStart >= 1440) realStart -= 1440;
                        if (realEnd >= 1440) realEnd -= 1440;
                        // Exkludera ordrar som INTE startar efter 22:30 eller slutar före 06:00 (efter midnatt)
                        if (shiftKey === 'Natt' && !(realStart >= 1350 || realEnd <= 360)) continue;
                        if (shiftStart + time > shiftEnd) continue;
                        order.startTime = realStart;
                        order.endTime = realEnd;
                        order.shift = shiftKey;
                        order.adjustedTime = time;
                        shifts[shiftKey].push(order);
                        order._scheduled = true;
                        shiftStart = order.endTime >= 1440 ? order.endTime - 1440 : order.endTime;
                        usedMinutes += time;
                        if (usedMinutes >= 24 * 60) break;
                    }
                    if (usedMinutes >= 24 * 60) break;
                }
                // Summera per skift
                summaries[machine] = { shifts: {} };
                Object.keys(shifts).forEach(shift => {
                    const totalKg = shifts[shift].reduce((acc, order) => acc + parseFloat(order['Planerad Vikt'] || 0), 0);
                    const totalOrders = shifts[shift].length;
                    const totalTime = shifts[shift].reduce((acc, order) => acc + order.adjustedTime, 0);
                    const kgPerHour = totalTime > 0 ? (totalKg / (totalTime / 60)) : 0;
                    summaries[machine].shifts[shift] = {
                        totalKg,
                        totalOrders,
                        totalTime,
                        kgPerHour,
                        orders: shifts[shift]
                    };
                });
                // Lägg till totalsummering över dygnet
                const allShifts = Object.values(summaries[machine].shifts);
                const totalDygnKg = allShifts.reduce((a,s)=>a+s.totalKg,0);
                const totalDygnOrders = allShifts.reduce((a,s)=>a+s.totalOrders,0);
                const totalDygnTime = allShifts.reduce((a,s)=>a+s.totalTime,0);
                const totalDygnKgPerHour = totalDygnTime > 0 ? (totalDygnKg/(totalDygnTime/60)) : 0;
                summaries[machine].totalDygn = {
                    totalKg: totalDygnKg,
                    totalOrders: totalDygnOrders,
                    totalTime: totalDygnTime,
                    kgPerHour: totalDygnKgPerHour
                };
            }

            const container = document.getElementById('machineSummaries');
            container.innerHTML = '';
            const shiftNames = { FM: 'FM', EM: 'EM', Natt: 'Natt' };
            const row = document.createElement('div');
            row.className = 'summary-row';
            machines.forEach(machine => {
                const data = summaries[machine];
                const div = document.createElement('div');
                div.className = 'summary-item summary-collapsible';
                // Totalt över dygnet box
                const total = data.totalDygn;
                const totalBox = `
                    <div class="summary-total-dygn">
                        <div style="font-size:1.13em;font-weight:700;letter-spacing:1px;">Totalt över dygnet</div>
                        <div style="margin-top:6px;font-size:1.08em;">
                            Ordrar: <b>${total.totalOrders}</b><br>
                            KG: <b>${total.totalKg.toFixed(2)}</b><br>
                            KG/TIM: <b>${total.kgPerHour.toFixed(2)}</b> ${(total.kgPerHour > 50) ? '📈' : '📉'}
                        </div>
                    </div>
                `;
                div.innerHTML = `
                    <div class="summary-header">
                        <h3 style="margin:0">${machine}</h3>
                        <span class="arrow">&#9654;</span>
                    </div>
                    ${totalBox}
                    <div class="summary-main">
                        <b>Teoretiskt (24h utan avbrott):</b><br>
                        KG/TIM: ${(() => {
                            const totKg = Object.values(data.shifts).reduce((a,s)=>a+s.totalKg,0);
                            return (totKg/24).toFixed(2);
                        })()}
                        <br>
                        <b>Med rastväxling:</b><br>
                        KG/TIM: ${(() => {
                            const totKg = Object.values(data.shifts).reduce((a,s)=>a+s.totalKg,0);
                            const normalRate = totKg/24;
                            const totalOutput = (22.5*normalRate) + (1.5*0.5*normalRate);
                            return (totalOutput/24).toFixed(2);
                        })()}
                    </div>
                    <div class="summary-shifts">
                        ${Object.keys(data.shifts).map(shift => {
                            const s = data.shifts[shift];
                            return `
                            <div class="shift-summary-mini">
                                <b>${shiftNames[shift]}</b>:<br>
                                Ordrar: ${s.totalOrders}<br>
                                KG: ${s.totalKg.toFixed(2)}<br>
                                KG/TIM: ${s.kgPerHour.toFixed(2)} ${s.kgPerHour > 50 ? '📈' : '📉'}
                            </div>
                            `;
                        }).join('')}
                    </div>
                `;
                div.addEventListener('click', function(e) {
                    // Stäng alla andra
                    document.querySelectorAll('.summary-collapsible').forEach(box => {
                        if (box !== div) {
                            box.querySelector('.summary-shifts').style.display = 'none';
                            box.classList.remove('active');
                        }
                    });
                    const shiftsDiv = div.querySelector('.summary-shifts');
                    if (shiftsDiv.style.display === 'block') {
                        shiftsDiv.style.display = 'none';
                        div.classList.remove('active');
                    } else {
                        shiftsDiv.style.display = 'block';
                        div.classList.add('active');
                    }
                    e.stopPropagation();
                });
                row.appendChild(div);
            });
            container.appendChild(row);
        }
        loadSummary();

        function formatMinutes(mins) {
            const h = Math.floor(mins / 60);
            const m = Math.round(mins % 60);
            return h + ' h ' + m.toString().padStart(2,'0') + ' min';
        }

        document.getElementById('calcBtn').addEventListener('click', function() {
            const order = {
                'Maskin id': document.getElementById('machineSelect').value,
                'Planerad Vikt': parseFloat(document.getElementById('plannedWeight').value) || 0,
                'Gramvikt': parseFloat(document.getElementById('gramvikt').value) || 0,
                'RawRollWidth': document.getElementById('rawRollWidth').value,
                'Arkbredd': parseFloat(document.getElementById('arkbredd').value) || 0,
                'Arklängd': parseFloat(document.getElementById('arklangd').value) || 0,
                'Antal banor': parseInt(document.getElementById('banor').value) || 1,
                'Reserverad Vikt': parseFloat(document.getElementById('resvikt').value) || 0,
                'Rullar': document.getElementById('rullar').value
            };
            const rolls = estimateRollCount(order);
            const { normalTime, saxningTime } = calculateProductionTime(order);
            const stops = calculateStopTimes(order);
            const resultDiv = document.getElementById('calcResult');
            resultDiv.innerHTML = `
                <p>Uppskattat antal rullar: <b>${rolls}</b></p>
                <p>Normal produktionstid: <b>${formatMinutes(normalTime)}</b></p>
                <p>Saxningstid: <b>${formatMinutes(saxningTime)}</b></p>
                <p>Stopp normal drift: <b>${formatMinutes(stops.normalStopTime/60)}</b></p>
                <p>Stopp saxning: <b>${formatMinutes(stops.saxningStopTime/60)}</b></p>
            `;
        });
    </script>
</body>
</html>
