<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM27 Produktionsplan</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="sm25-app">
        <aside class="sm25-sidebar">
            <div class="sm25-logo">SM27</div>
            <nav>
                <a href="index.html" class="sidebar-link">&#8592; Tillbaka till √∂versikt</a>
            </nav>
            <div class="sm25-shift-sidebar" style="display: flex; flex-direction: column; align-items: stretch; gap: 24px;">
                <h2 style="margin-bottom: 0;">V√§lj skift</h2>
                <div class="sm25-shift-list" style="display: flex; flex-direction: column; gap: 16px;">
                    <button class="sm25-shift-btn" data-shift="FM">FM-Skift</button>
                    <button class="sm25-shift-btn" data-shift="EM">EM-Skift</button>
                    <button class="sm25-shift-btn" data-shift="Natt">Natt-Skift</button>
                </div>
            </div>
            <div class="sm25-machine-info">
                <div class="machine-info-header">
                    <span class="machine-icon">üñ®Ô∏è</span>
                    <h2>SM27</h2>
                </div>
                <div class="machine-info-details">
                    <div class="machine-info-row"><b>Skift:</b> <span>FM, EM, Natt</span></div>
                    <div class="machine-info-row"><b>Starttid:</b> <span>06:00</span></div>
                </div>
            </div>
        </aside>
        <main class="sm25-main">
            <header class="sm25-header">
                <h1>SM27 Produktionsplan</h1>
                <p class="sm25-sub">Planering och utr√§kning f√∂r dagens produktion. V√§lj skift i sidomenyn.</p>
            </header>
            <div id="ordersContainer"></div>
        </main>
    </div>
    <div class="guidance">
        <p><strong>√ñvrigt att t√§nka p√•:</strong> Tider baseras p√• "Arkl√§ngd" och "RawRollWidth". Anv√§nd stoppfunktionen vid pauser. Kontrollera varningar f√∂r saknad data.</p>
    </div>
    <script src="production.js"></script>
    <script>
        let isPaused = false;
        let pauseStartTime = 0;
        let totalPauseTime = 0;

        async function loadOrders() {
            const response = await fetch('SM27.json');
            const orders = await response.json();
            const ordersWithTimes = calculateAllProductionTimes(orders);
            const ordersContainer = document.getElementById('ordersContainer');
            ordersContainer.innerHTML = '';
            const shifts = { FM: [], EM: [], Natt: [] };
            const shiftLimits = {
                FM: 14 * 60, // 06:00-14:00
                EM: 22.5 * 60, // 14:00-22:30
                Natt: 30 * 60 // 22:30-06:00 (n√§sta dag)
            };
            let currentTime = 6 * 60; // Start vid 06:00 i minuter
            let usedMinutes = 0;
            let shiftCurrent = { FM: 6 * 60, EM: 14 * 60, Natt: 22.5 * 60 };
            // Fyll varje skift f√∂r sig tills dess sluttid
            for (let shiftKey of ['FM', 'EM', 'Natt']) {
                let shiftStart = shiftCurrent[shiftKey];
                let shiftEnd = shiftLimits[shiftKey];
                for (let i = 0; i < ordersWithTimes.length; i++) {
                    const order = ordersWithTimes[i];
                    if (order._scheduled) continue; // Hoppa redan schemalagda ordrar
                    const time = order.productionTimeNormal || order.productionTimeSaxning || 0;
                    const adjustedTime = isPaused ? time + (totalPauseTime / 60) : time;
                    // Om ordern inte f√•r plats i skiftet, hoppa √∂ver
                    if (shiftStart + adjustedTime > shiftEnd) continue;
                    order.startTime = shiftStart;
                    order.endTime = shiftStart + adjustedTime;
                    order.shift = shiftKey;
                    order.adjustedTime = adjustedTime;
                    order.productionTime = time;
                    order.isSaxning = (parseFloat(order['RawRollWidth'] || '0') <= 1035 && estimateRollCount(order) >= 2);
                    order.isProfitable = order.isSaxning ? (order.productionTimeSaxning < order.productionTimeNormal) : false;
                    shifts[shiftKey].push(order);
                    order._scheduled = true;
                    shiftStart = order.endTime;
                    usedMinutes += adjustedTime;
                    if (usedMinutes >= 24 * 60) break;
                }
                if (usedMinutes >= 24 * 60) break;
            }

            // Skift-knappar och summering
            const shiftNames = { FM: 'FM-Skift', EM: 'EM-Skift', Natt: 'Natt-Skift' };
            Object.keys(shifts).forEach(shift => {
                // Skift-knapp
                const btn = document.createElement('button');
                btn.className = 'shift-toggle';
                btn.innerHTML = `<span class="shift-arrow">&#9654;</span> ${shiftNames[shift]}`;
                btn.setAttribute('data-shift', shift);
                btn.onclick = function() {
                    const section = document.getElementById('section-' + shift);
                    const isOpen = section && section.style.display === 'block';
                    Object.keys(shifts).forEach(s => {
                        const sec = document.getElementById('section-' + s);
                        if (sec) sec.style.display = 'none';
                        const b = document.querySelector(`button[data-shift="${s}"]`);
                        if (b) {
                            b.classList.remove('active-shift');
                            const arrow = b.querySelector('.shift-arrow');
                            if (arrow) arrow.innerHTML = '&#9654;';
                        }
                    });
                    if (!isOpen) {
                        section.style.display = 'block';
                        btn.classList.add('active-shift');
                        const arrow = btn.querySelector('.shift-arrow');
                        if (arrow) arrow.innerHTML = '&#9660;';
                        section.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                };
                ordersContainer.appendChild(btn);

                // Summering
                const shiftSummary = document.createElement('div');
                shiftSummary.className = 'shift-summary';
                const totalKg = shifts[shift].reduce((acc, order) => acc + parseFloat(order['Planerad Vikt'] || 0), 0);
                const totalOrders = shifts[shift].length;
                const totalTime = shifts[shift].reduce((acc, order) => acc + order.adjustedTime, 0);
                const kgPerHour = totalTime > 0 ? (totalKg / (totalTime / 60)) : 50;
                const isHighProduction = kgPerHour > 50;
                const analysis = [];
                if (isHighProduction) {
                    analysis.push('+ H√∂g produktionstakt, effektiva ordrar. üìà');
                    if (totalOrders > 5) analysis.push('+ M√•nga ordrar √∂kar genomstr√∂mning.');
                } else {
                    analysis.push('- L√•g produktionstakt, kontrollera orderstorlek. üìâ');
                    if (totalOrders < 3) analysis.push('- F√• ordrar kan minska effektivitet.');
                }
                shiftSummary.innerHTML = `
                    <h3>Summering f√∂r ${shiftNames[shift]}:</h3>
                    <p>Planerad produktion: ${totalKg.toFixed(2)} kg</p>
                    <p>K√∂rda ordrar: ${totalOrders}</p>
                    <p>Summa KG/TIM: ${kgPerHour.toFixed(2)}</p>
                    <div class="analysis">${analysis.map(a => `<p>${a}</p>`).join('')}</div>
                `;
                ordersContainer.appendChild(shiftSummary);

                // Skiftsektion (collapsible)
                const shiftDiv = document.createElement('div');
                shiftDiv.className = 'shift-section';
                shiftDiv.id = 'section-' + shift;
                shiftDiv.style.display = 'none';

                // Ny grid-container f√∂r ordrar
                const ordersGrid = document.createElement('div');
                ordersGrid.className = 'orders-grid';
                shifts[shift].forEach(order => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'order-box';
                    orderDiv.innerHTML = `
                        <h3>Order: ${order['Kundorder'] || 'Ok√§nd'}</h3>
                        <p>Planerad start: ${formatTime(order.startTime)}</p>
                        <p>F√§rdig ca: ${formatTime(order.endTime)}</p>
                        <p>Totalt tids√•tg√•ng: ${order.adjustedTime.toFixed(2)} min</p>
                        <p>Planerad Vikt: ${(order['Planerad Vikt'] || 0).toFixed(2)} kg</p>
                        <button class="show-calc-btn">Visa Utr√§kning</button>
                        <div class="calc-result" style="display:none;"></div>
                    `;
                    orderDiv.querySelector('.show-calc-btn').addEventListener('click', function() {
                        showOrderCalculation(this, order);
                    });
            const resultDiv = btn.nextElementSibling;
            if (resultDiv.style.display === 'block') {
                resultDiv.style.display = 'none';
                return;
            }
            resultDiv.style.display = 'block';

            // H√§mta ut v√§rden
            const orderId = order['Kundorder'] || 'Ok√§nd';
            const productionTimeNormal = order.productionTimeNormal || 0;
            const productionTimeSaxning = order.productionTimeSaxning || 0;
            const sheetLength = parseFloat(order['Arkl√§ngd']) || 0;
            const rawRollWidth = order['RawRollWidth'];
            const plannedWeight = parseFloat(order['Planerad Vikt']) || 0;
            const gramvikt = parseFloat(order['Gramvikt']) || 0;
            const lanes = parseFloat(order['Antal banor']) || 1;

            if (!sheetLength || !rawRollWidth || !plannedWeight || !gramvikt) {
                resultDiv.innerHTML = `<span style='color:#b91c1c'><strong>Kan inte visa utr√§kning:</strong> Saknar n√∂dv√§ndig data (Arkl√§ngd, RawRollWidth, Planerad Vikt, Gramvikt).</span>`;
                return;
            }

            const speed = getMachineSpeed('SM27', sheetLength);
            const rawRollWidthFirst = parseFloat((rawRollWidth+'').split(',')[0]);
            let L = (plannedWeight * 1000000) / (gramvikt * rawRollWidthFirst);
            let L_per_lane = L;
            let lengthFormula = `(${plannedWeight} √ó 1 000 000) / (${gramvikt} √ó ${rawRollWidthFirst})`;
            if (lanes > 1) {
                L_per_lane = L / lanes;
                lengthFormula += ` / ${lanes}`;
            }
            const productionTimeMinutes = L_per_lane / speed;
            const stopObj = calculateStopTimes(order);
            const stopTime = stopObj.normalStopTime / 60;
            const totalTime = productionTimeMinutes + stopTime;

            function formatMinutesToHMM(mins) {
                const h = Math.floor(mins / 60);
                const m = Math.round(mins % 60);
                return h + ' h ' + m.toString().padStart(2, '0') + ' min';
            }
            let comparisonText = '';
            if (order.isSaxning) {
                comparisonText = `<em>J√§mf√∂relse: Normal tid: ${formatMinutesToHMM(productionTimeNormal)}, Saxning: ${formatMinutesToHMM(productionTimeSaxning)}</em>`;
            } else {
                comparisonText = `<em>Normal tid: ${formatMinutesToHMM(productionTimeNormal)}</em>`;
            }

            // Stegdata med f√∂rklaring
            const steps = [
                {
                    title: 'L√§ngd (L)',
                    desc: 'Ber√§knar den totala l√§ngden papper som ska produceras utifr√•n vikt, gramvikt och r√•valsbredd.',
                    formula: `L = (Planerad Vikt √ó 1 000 000) / (Gramvikt √ó RawRollWidth)${lanes > 1 ? ' / Antal banor' : ''}`,
                    values: lengthFormula,
                    result: `<b>${L_per_lane.toFixed(2)} m</b>`
                },
                {
                    title: 'Produktionstid',
                    desc: 'Ber√§knar hur l√•ng tid det tar att producera l√§ngden L med aktuell maskinhastighet.',
                    formula: 'Produktionstid = L / Hastighet',
                    values: `${L_per_lane.toFixed(2)} / ${speed.toFixed(2)}`,
                    result: `<b>${formatMinutesToHMM(productionTimeMinutes)}</b>`
                },
                {
                    title: 'Stopptid',
                    desc: 'Summerar planerade stopp (t.ex. rullbyten) f√∂r ordern.',
                    formula: 'Stopptid (fr√•n script)',
                    values: `${stopObj.normalStopTime} sek = ${(stopTime).toFixed(2)} min`,
                    result: `<b>${formatMinutesToHMM(stopTime)}</b>`
                },
                {
                    title: 'Total tid',
                    desc: 'L√§gger ihop produktionstid och stopptid f√∂r att f√• orderns totala k√∂rtid.',
                    formula: 'Produktionstid + Stopptid',
                    values: `${formatMinutesToHMM(productionTimeMinutes)} + ${formatMinutesToHMM(stopTime)}`,
                    result: `<b>${formatMinutesToHMM(totalTime)}</b>`
                }
            ];

            // Rendera steg i en stor, horisontell, tydlig layout
            let stepsHtml = `<div class=\"calc-steps-horizontal\">
                ${steps.map((step, i) => `
                    <div class=\"calc-step-big\" data-step=\"${i}\">
                        <div class=\"calc-step-header-big\">
                            <span class=\"calc-step-title\">${i+1}. ${step.title}</span>
                            <span class=\"calc-step-arrow-big\">&#9654;</span>
                        </div>
                        <div class=\"calc-step-content-big\">
                            <div class=\"calc-step-desc\">${step.desc}</div>
                            <div class=\"calc-step-formula\"><b>Formel:</b> ${step.formula}</div>
                            <div class=\"calc-step-values\"><b>V√§rden:</b> ${step.values}</div>
                            <div class=\"calc-step-result\"><b>Resultat:</b> ${step.result}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div style=\"margin-top:16px; color:#555; font-size:1.08em;\">${comparisonText}</div>`;

            resultDiv.innerHTML = stepsHtml;

            // Expanderbar logik: endast ett steg √∂ppet √•t g√•ngen
            const stepDivs = resultDiv.querySelectorAll('.calc-step-big');
            stepDivs.forEach((div, idx) => {
                const content = div.querySelector('.calc-step-content-big');
                const arrow = div.querySelector('.calc-step-arrow-big');
                content.style.display = 'none';
                div.addEventListener('click', function(e) {
                    stepDivs.forEach((other, j) => {
                        const otherContent = other.querySelector('.calc-step-content-big');
                        const otherArrow = other.querySelector('.calc-step-arrow-big');
                        if (j === idx) {
                            const isOpen = otherContent.style.display === 'block';
                            otherContent.style.display = isOpen ? 'none' : 'block';
                            otherArrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(90deg)';
                        } else {
                            otherContent.style.display = 'none';
                            otherArrow.style.transform = 'rotate(0deg)';
                        }
                    });
                    e.stopPropagation();
                });
            });
        }

        function addStop() {
            if (!isPaused) {
                isPaused = true;
                pauseStartTime = new Date().getTime();
                document.getElementById('stopInfo').textContent = 'Stopp pausat, klicka igen f√∂r att √•teruppta.';
            } else {
                const pauseEndTime = new Date().getTime();
                const pauseDuration = (pauseEndTime - pauseStartTime) / 1000 / 60; // Minuter
                totalPauseTime += pauseDuration;
                isPaused = false;
                document.getElementById('stopInfo').textContent = `Stopp √•terupptaget, paus: ${pauseDuration.toFixed(2)} min. Omr√§knat.`;
                loadOrders(); // Omr√§kna med ny tid
            }
        }

        // Hj√§lpfunktion f√∂r att formatera tid
        function formatTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = Math.round(minutes % 60);
            return `kl ${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        loadOrders();

        // Efter loadOrders, l√§gg till kod f√∂r att f√∂rb√§ttra UI:t direkt i scriptet (f√∂r att undvika 90-talsk√§nsla)
        document.addEventListener('DOMContentLoaded', function() {
            // Modernare font och bakgrund
            document.body.style.background = 'linear-gradient(120deg, #f8fafc 0%, #e0e7ef 100%)';
            document.body.style.fontFamily = 'Roboto, Arial, sans-serif';
            document.body.style.fontSize = '18px';
            document.body.style.color = '#222';
            // Container
            const container = document.querySelector('.container');
            if (container) {
                container.style.maxWidth = '900px';
                container.style.margin = '40px auto';
                container.style.background = '#fff';
                container.style.borderRadius = '18px';
                container.style.boxShadow = '0 4px 24px 0 rgba(60,80,120,0.10)';
                container.style.padding = '32px 32px 24px 32px';
            }
            // Skiftbar
            const style = document.createElement('style');
            style.innerHTML = `
                .shift-bar { display: flex; justify-content: center; gap: 24px; margin: 32px 0 16px 0; }
                .shift-toggle { position: relative; font-weight: 600; letter-spacing: 0.5px; box-shadow: 0 2px 8px #e0e7ef, 0 0 0 2px #3b82f6 inset; }
                .shift-toggle .shift-arrow { font-size: 1.2em; margin-right: 8px; transition: transform 0.2s; }
                .shift-toggle.active-shift .shift-arrow { transform: rotate(90deg); }
                .shift-toggle:after { content: 'Klicka f√∂r att visa'; display: block; font-size: 0.85em; color: #2563eb; margin-top: 2px; font-weight: 400; letter-spacing: 0; }
                .shift-wrapper { background: #f4f7fb; border-radius: 0 0 12px 12px; box-shadow: 0 2px 12px #e0e7ef; margin-bottom: 32px; padding: 24px 24px 12px 24px; }
                .shift-summary { background: #e0e7ef; border-radius: 8px; margin: 0 0 18px 0; padding: 16px 20px; font-size: 1.08em; }
                .orders-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
                    gap: 18px 18px;
                    margin-top: 18px;
                }
                .order-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(270px, 1fr)); gap: 22px 22px; margin-top: 10px; }
                .order-box { background: #fff; border-radius: 8px; box-shadow: 0 1px 6px #e0e7ef; margin: 18px 0; padding: 18px 22px; display: flex; flex-direction: column; gap: 6px; min-width: 0; }
                .order-box h3 { margin: 0 0 4px 0; font-size: 1.15em; color: #2563eb; }
                .order-box button { align-self: flex-start; background: #3b82f6; color: #fff; border: none; border-radius: 6px; padding: 7px 18px; font-size: 1em; margin-top: 6px; cursor: pointer; transition: background 0.2s; }
                .order-box button:hover { background: #2563eb; }
                .calc-result { background: #f1f5fa; border-left: 4px solid #3b82f6; border-radius: 0 6px 6px 0; margin: 10px 0 0 0; padding: 10px 18px; font-size: 0.98em; color: #234; }
                @media (max-width: 700px) {
                    .container { padding: 8px !important; }
                    .shift-bar { flex-direction: column; gap: 10px; }
                    .shift-wrapper { padding: 10px 4px; }
                    .order-box { padding: 10px 6px; }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
